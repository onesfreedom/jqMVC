/*!
 * jqMVC.js (C) 2015 Garrett R Morris, MIT license http://github.com/r3wt/jqMVC.git
 * @author Garrett R Morris (https://github.com/r3wt)
 * @package jqMVC.js
 * @license MIT
 * @version 0.3.4
 * router contains heavily modified code originally written by camilo tapia https://github.com/camme/jquery-router-plugin
 */
!function(e,t,n){function u(e){return typeof e!="undefined"}function a(e){return typeof e=="string"}function f(e){return e&&e.document&&e.location&&e.alert&&e.setInterval}function l(e){return t.document===e}function c(e){return e===H}function h(e,t,n){return e.hasOwnProperty(t)||(e[t]={}),function(r,i){return e[t][r]=i,n}}function p(){var e=app_path.replace(t.location.origin,"").replace(/\/+/g,"/").trim("/");return e.length===0&&(e+="/"),e}function d(){var e=v(location.pathname),t=m(e);if(t.length===0)b("notFound");else for(var n=0;n<t.length;n++){var r=t[n];console.log(r);var i=[];for(var s in t[n].data)i.push(t[n].data[s]);var o={items:r.middleware.slice(),halt:function(e){b("mwReject",i),e.apply(this)},next:function(){o.items.length>0?o.items.shift().call(this,o):r.callback.apply(this,i)}};o.next()}}function v(e){var t=e?e:location.pathname;t=decodeURI(t);if(!C){if(location.hash.indexOf("#!/")!==0)return"";t+=location.hash.substring(3)}return t.slice(-1)=="/"&&(t=t.substring(0,t.length-1)),t}function m(e){var t=[];for(var n=0;n<A.length;n++){var r=A[n];if(r.type=="regexp"){var i=e.match(r.route);if(i){var s=function(){return r}();s.data={matches:i},t.push(s);break}}else{var o=e.split("/"),u=r.route.split("/");if(u.length==o.length){var a={},f=!0,l=0;for(var c=0;c<u.length;c++)u[c].indexOf(":")===0?(a[u[c].substring(1)]=decodeURI(o[c]),l++):u[c]==o[c]&&l++;if(u.length==l){var s=function(){return r}();s.data=a,t.push(s),P.currentParameters=a;break}}}}return t}function g(e){e!=null&&e.originalEvent&&e.originalEvent.state!==undefined?d():L?d():!L&&!C&&d()}function y(e){debug&&t.console&&console.log("$.jqMVC :: "+e)}function b(t,n){y("emit -> `"+t+"`"),e(H).trigger(t,n)}function x(){for(var t=0;t<E.length;t++)e(E[t]).find("*").addBack().off();E.length=0,clearInterval(P.interval)}function T(){for(var e in S)S[e].apply(this)}t.location.origin=t.location.protocol+"//"+t.location.hostname+(t.location.port?":"+t.location.port:""),t.ctrl={},t.svc={},function(e){var t=e.fn.jquery.split("."),n=[];for(var r=0;r<t.length;r++)n.push(parseInt(t[r]));switch(!0){case n[0]<2:case n[1]<1:case n[2]<3:throw"jqMVC requires jQuery 2.1.3 or greater. Upgrade dummy!"}}(e),e.fn.serializeObject=function(){var e=this.serializeArray(),t={};for(var n=0;n<e.length;n++)t[e[n].name]=e[n].value;return t};var r={alert:function(e){alert(e)},confirm:function(e,t){confirm(e)&&t.apply(this)}},i={start:function(){},stop:function(){}},s={render:function(){throw H.done(),"You must implement a view with `setView()` before you can render templates"}},o={},w=e.fn.init,E=[],S={};e.fn.init=function(n){var r=u(n)&&!c(n)&&(a(n)||f(n)||l(n))!==!1,i=new w(n,t.document,e);return r&&(E=H.merge(E,[n])),i},S.bindRouter=function(){O=!0,P.fromHash=!1;if(C){if(location.hash.indexOf("#!/")===0){var n=location.pathname+location.hash.replace(/^#!\//gi,"");history.replaceState({},"",n),P.fromHash=!0}e(t).bind("popstate",g)}else L?e(t).bind("hashchange.router",g):P.interval=setInterval(function(){location.href!=M&&(g(),M=location.href)},500)},S.bindHref=function(){e(n).on("click","a[data-href]",function(t){return t.preventDefault(),b("before.go"),H.go(p().replace(/\/+$/,"")+e(this).data("href"),"Loading"),!1})},S.bindForm=function(){e(n).on("submit","form[ctrl][action][callback]",function(n){n.preventDefault();var r=e(this),i=r.attr("before"),s=r.attr("callback"),o=api_path+r.attr("action"),u=t.ctrl[r.attr("ctrl")],a=r.serializeObject();console.log(a),e.jqMVC.before(),r.find('button[type="submit"]').prop("disabled",!0);if(typeof i!="undefined"&&i!==!1){var f=u[i].call(r);if(f!==!1){e.jqMVC.alert(f,"error");return}}if(typeof s=="undefined"||s===!1){e.jqMVC.alert("FORM DOES NOT SPECIFY CALLBACK. UNABLE TO CONTINUE.","error");return}return e.post(o,a,function(e){var e=JSON.parse(e);u[s].call(r,e)}).fail(function(e,t,n){u[s].call(r,{error:1,message:"An Unknown Error Occured: "+e.status+" "+e.responseText})}).always(function(){e.jqMVC.done(),r.find('button[type="submit"]').prop("disabled",!1)}),!1})};var N={};N.items=[],N.next=function(){N.items.shift().call(e,N)};var C=history&&history.pushState,L=!C&&"onhashchange"in t&&!1,A=[],O=!1,M=location.href,_=!0,D=!1,P={};P.interval=null,P.currentId="",P.currentParameters={},P.capabilities={hash:L,pushState:C,timer:!L&&!C},P.checkRoute=function(e){return m(v(e)).length>0},P.parameters=function(e){var t=v(e),n=m(t);return n.length==0?P.currentParameters={}:P.currentParameters=n[0].data,P.currentParameters};var H={};H.add=function(e){return N.items.push(e),H},H.addBinding=function(e,t){if(binding_override||!S.hasOwnProperty(e))S[e]=t;return H},H.addSvc=function(e,t){return svc[e]=t,H},H.alert=function(){return r.alert.apply(this,arguments),H},H.before=function(){return i.start(),H},H.confirm=function(){return r.confirm.apply(this,arguments),H},H.ctrl=function(e,t){return ctrl[e]=t,H},H.data=function(e){for(var n in e)t[n]=e[n];return H},H.done=function(e){return b("on.done"),i.stop(),x(),T(),typeof e=="function"&&e.apply(this),H},H.go=function(e){if(C)history.pushState({},null,e),d(),O||S.bindRouter();else{O||S.bindRouter(),e=e.replace(location.protocol+"//","").replace(location.hostname,"");var t=e.replace(location.pathname,"");t.indexOf("!")<0&&(t="!/"+t),location.hash=t}return H},H.loadModules=function(t){return t.length>0&&H.add(function(r){function i(e){var t=new Promise(function(t,r){var i=n.createElement("script");i.src=e,i.addEventListener("load",function(){t(e)},!1),i.addEventListener("error",function(){r(e)},!1),n.body.appendChild(i)});return t}(new Promise(function(n,r){var s=0,o={};for(var u=0;u<t.length;u++)i(p()+module_path+t[u]).then(function(){s++,e(o).trigger("check")},function(){s++,e(o).trigger("check")});e(o).on("check",function(){s>=t.length&&n()})})).then(r.next,r.next)}),H},H.listen=function(t,n){return e(H).bind(t,n),H},H.listenOnce=function(t,n){return e(H).one(t,n),H},H.merge=function(){var e=[],t=[],n=function(e,t){var e=e.concat(t);for(var n=0;n<e.length;++n)for(var r=n+1;r<e.length;++r)e[n]===e[r]&&e.splice(r--,1);return e};Array.prototype.push.apply(e,arguments);for(k=0;k<e.length;k++)t=n(t,e[k]);return t},H.path=function(){var e=[];Array.prototype.push.apply(e,arguments);var t=e.shift(),n=e.pop(),r=e;t=p().replace(/\/+$/,"")+t;var i=typeof t=="object";return i||(t.lastIndexOf("/")==t.length-1&&(t=t.substring(0,t.length-1)),t=t.replace(location.protocol+"//","").replace(location.hostname,"")),A.push({route:t,middleware:r,callback:n,type:i?"regexp":"string"}),H},H.render=function(){return s.render.apply(this,arguments),H},H.run=function(){D||(b("firstRun"),D=!0,H.add(function(){H.go(location.href)}),N.next()),H.run=function(){}},H.setNotification=function(e){return r=e,H},H.setProgress=function(e){return i=e,H},H.setView=function(e){return s=e,H},H.trigger=function(e,t){return b(e,t),H},H.data({app_path:t.location.origin,api_path:"/api/",view_path:"/views",module_path:"/modules",model_path:"/models",element:e("body"),debug:!1,binding_override:!1}),e.jqMVC=H}(jQuery,window,document)