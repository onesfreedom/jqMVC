/*!
 * jqMVC.js (C) 2015 Garrett R Morris, MIT license http://github.com/r3wt/jqMVC.git
 * @author Garrett R Morris (https://github.com/r3wt)
 * @package jqMVC.js
 * @license MIT
 * @version 0.3.5
 * router contains heavily modified code originally written by camilo tapia https://github.com/camme/jquery-router-plugin
 */
!function(e,t,n){function u(e){return typeof e!="undefined"}function a(e){return typeof e=="string"}function f(e){return e&&e.document&&e.location&&e.alert&&e.setInterval}function l(e){return t.document===e}function c(e){return e===P}function h(){var e=app_path.replace(t.location.origin,"").replace(/\/+/g,"/").trim("/");return e.length===0&&(e+="/"),e}function p(){var e=d(location.pathname),t=v(e);if(t.length===0)y("notFound");else for(var n=0;n<t.length;n++){var r=t[n];g(r);var i=[];for(var s in t[n].data)i.push(t[n].data[s]);var o={items:r.middleware.slice(),halt:function(e){y("router.mw.reject"),e.apply(this)},next:function(){y("router.mw.next"),o.items.length>0?o.items.shift().call(this,o):r.callback.apply(this,i)}};o.next()}}function d(e){var t=e?e:location.pathname;t=decodeURI(t);if(!N){if(location.hash.indexOf("#!/")!==0)return"";t+=location.hash.substring(3)}return t.slice(-1)=="/"&&(t=t.substring(0,t.length-1)),t}function v(e){var t=[];for(var n=0;n<L.length;n++){var r=L[n];if(r.type=="regexp"){var i=e.match(r.route);if(i){var s=function(){return r}();s.data={matches:i},t.push(s);break}}else{var o=e.split("/"),u=r.route.split("/");if(u.length==o.length){var a={},f=!0,l=0;for(var c=0;c<u.length;c++)u[c].indexOf(":")===0?(a[u[c].substring(1)]=decodeURI(o[c]),l++):u[c]==o[c]&&l++;if(u.length==l){var s=function(){return r}();s.data=a,t.push(s),D.currentParameters=a;break}}}}return t}function m(e){e!=null&&e.originalEvent&&e.originalEvent.state!==undefined?p():C?p():!C&&!N&&p()}function g(){debug&&t.console&&console.log.apply(this,arguments)}function y(t,n){g("jQmv -> emit -> `"+t+"`"),e(P).trigger(t,n)}function S(){g("jqMVC -> unbindEvents",w.length+"events to be removed");for(var t=0;t<w.length;t++)e(w[t]).find("*").addBack().off();w.length=0,clearInterval(D.interval)}function x(){g("jqMVC -> bindEvents",E);for(var e in E)E[e].apply(this)}t.location.origin=t.location.protocol+"//"+t.location.hostname+(t.location.port?":"+t.location.port:""),t.ctrl={},t.svc={},function(e){var t=e.fn.jquery.split("."),n=[];for(var r=0;r<t.length;r++)n.push(parseInt(t[r]));switch(!0){case n[0]<2:case n[1]<1:case n[2]<3:throw"jqMVC requires jQuery 2.1.3 or greater. Upgrade dummy!"}g("using jQuery version "+n.join("."))}(e),e.fn.serializeObject=function(){var e=this.serializeArray(),t={};for(var n=0;n<e.length;n++)t[e[n].name]=e[n].value;return t};var r={alert:function(e){alert(e)},confirm:function(e,t){confirm(e)&&t.apply(this)}},i={start:function(){},stop:function(){}},s={render:function(){throw P.done(),"You must implement a view library to use this feature."}},o={},b=e.fn.init,w=[],E={};e.fn.init=function(n){var r=u(n)&&!c(n)&&(a(n)||f(n)||l(n))!==!1,i=new b(n,t.document,e);return r&&(w=P.merge(w,[n])),i},E.bindRouter=function(){A=!0,D.fromHash=!1;if(N){if(location.hash.indexOf("#!/")===0){var n=location.pathname+location.hash.replace(/^#!\//gi,"");history.replaceState({},"",n),D.fromHash=!0}e(t).bind("popstate",m)}else C?e(t).bind("hashchange.router",m):D.interval=setInterval(function(){location.href!=O&&(m(),O=location.href)},500)},E.bindHref=function(){e(n).on("click","a[data-href]",function(t){return t.preventDefault(),y("before.go"),P.go(h().replace(/\/+$/,"")+e(this).data("href"),"Loading"),!1})},E.bindForm=function(){e(n).on("submit","form[method][ctrl][action][callback]",function(n){function i(){r.el.find('button[type="submit"]').prop("disabled",!0),e.ajax({url:api_path+r.action,type:""+r.method.toUpperCase(),data:r.data,contentType:r.type,cache:!1,processData:r.processData,success:function(e){var e=JSON.parse(e);t.ctrl[r.ctrl][r.cb].call(r.el,e)},error:function(e,n,i){t.ctrl[r.ctrl][r.cb].call(r.el,{error:1,message:e.status+" "+e.responseText})}}).always(function(){r.el.find('button[type="submit"]').prop("disabled",!1)})}n.preventDefault();var r={};return r.el=e(this),r.method=r.el.attr("method"),r.action=r.el.attr("action"),r.ctrl=r.el.attr("ctrl"),r.bf=r.el.attr("before"),r.cb=r.el.attr("callback"),r.isFile=!!r.el.find(':input[type="file"]').length,r.isFile?(r.data=new FormData(this),r.type=!1,r.processData=!1):(r.data=r.el.serializeObject(),r.type="application/x-www-form-urlencoded; charset=UTF-8",r.processData=!0),typeof r.bf=="function"?(new Promise(t.ctrl[r.ctrl][r.bf])).then(function(){i()},function(){}):i(),g(t,r),!1})},E.bindModel=function(){};var T={};T.items=[],T.next=function(){g("jqMVC -> middleware -> stack.next()"),T.items.shift().call(e,T)};var N=history&&history.pushState,C=!N&&"onhashchange"in t&&!1,L=[],A=!1,O=location.href,M=!0,_=!1,D={};D.interval=null,D.currentId="",D.currentParameters={},D.capabilities={hash:C,pushState:N,timer:!C&&!N},D.checkRoute=function(e){return v(d(e)).length>0},D.parameters=function(e){var t=d(e),n=v(t);return n.length==0?D.currentParameters={}:D.currentParameters=n[0].data,D.currentParameters};var P={};P.add=function(e){return T.items.push(e),P},P.addBinding=function(e,t){if(binding_override||!E.hasOwnProperty(e))E[e]=t;return P},P.addSvc=function(e,t){return svc[e]=t,P},P.alert=function(){return r.alert.apply(this,arguments),P},P.before=function(){return i.start(),P},P.confirm=function(){return r.confirm.apply(this,arguments),P},P.ctrl=function(e,t){return ctrl[e]=t,P},P.data=function(e){for(var n in e)t[n]=e[n];return P},P.done=function(e){return y("on.done"),i.stop(),S(),x(),typeof e=="function"&&e.apply(this),P},P.go=function(e){if(N)history.pushState({},null,e),p(),A||E.bindRouter();else{A||E.bindRouter(),e=e.replace(location.protocol+"//","").replace(location.hostname,"");var t=e.replace(location.pathname,"");t.indexOf("!")<0&&(t="!/"+t),location.hash=t}return P},P.loadModules=function(t){return t.length>0&&P.add(function(r){function i(e){var t=new Promise(function(t,r){var i=n.createElement("script");i.src=e,i.addEventListener("load",function(){t(e)},!1),i.addEventListener("error",function(){r(e)},!1),n.body.appendChild(i)});return t}(new Promise(function(n,r){var s=0,o={};for(var u=0;u<t.length;u++)i(h()+module_path+t[u]).then(function(){s++,e(o).trigger("check")},function(){s++,e(o).trigger("check")});e(o).on("check",function(){s>=t.length&&n()})})).then(r.next,r.next)}),P},P.listen=function(t,n){return e(P).bind(t,n),P},P.listenOnce=function(t,n){return e(P).one(t,n),P},P.merge=function(){var e=[],t=[],n=function(e,t){var e=e.concat(t);for(var n=0;n<e.length;++n)for(var r=n+1;r<e.length;++r)e[n]===e[r]&&e.splice(r--,1);return e};Array.prototype.push.apply(e,arguments);for(k=0;k<e.length;k++)t=n(t,e[k]);return t},P.model=function(e,t){return o[e]=t,P},P.path=function(){var e=[];Array.prototype.push.apply(e,arguments);var t=e.shift(),n=e.pop(),r=e;t=h().replace(/\/+$/,"")+t;var i=typeof t=="object";return i||(t.lastIndexOf("/")==t.length-1&&(t=t.substring(0,t.length-1)),t=t.replace(location.protocol+"//","").replace(location.hostname,"")),L.push({route:t,middleware:r,callback:n,type:i?"regexp":"string"}),P},P.render=function(){return s.render.apply(this,arguments),P},P.run=function(){_||(y("firstRun"),_=!0,P.add(function(){P.go(location.href)}),T.next()),P.run=function(){}},P.setModel=function(e){return o=e,P},P.setNotification=function(e){return r=e,P},P.setProgress=function(e){return i=e,P},P.setView=function(e){return s=e,P},P.trigger=function(e,t){return y(e,t),P},P.data({app_path:t.location.origin,api_path:"/api/",view_path:"/views",module_path:"/modules",model_path:"/models",element:e("body"),debug:!1,binding_override:!1}),e.jqMVC=P}(jQuery,window,document)