/**
 * jqMVC - The jQuery MVC Framework
 *
 * @version   0.3.8
 * @link      https://github.com/r3wt/jqMVC
 * @copyright (c) 2015 Garrett R. Morris
 * @license   https://github.com/r3wt/jqMVC/blob/master/LICENSE (MIT License)
 * @build     2015-11-18_04:12:01 UTC
 */
!function(e,t,n){function E(e){return typeof e!="undefined"}function S(e){return typeof e=="string"}function x(e){return e&&e.document&&e.location&&e.alert&&e.setInterval}function T(e){return t.document===e}function N(e){return e===r}function C(){var e=app_path.replace(t.location.origin,"").replace(/\/+/g,"/").trim("/");return e.length?e:"/"}function L(){var e=(t.location.search||"?").substr(1);return e.length?e.trim().split("&").reduce(function(e,t){var n=t.replace(/\+/g," ").split("=");return e[n[0]]=n[1]===undefined?null:decodeURIComponent(n[1]),e},{}):{}}function A(){var e=M(location.pathname),t=_(e),n=t.slice();P(n),O(n)}function O(n){if(n.length===0)H("notFound");else{var r=n.shift(),i=n.slice(),s=t.onerror;t.onerror=function(e,t,n){return!0};function o(){t.onerror=s,P("jqMVC -> router -> accept")}try{var u=[];for(var a in r.data)u.push(r.data[a]);var f={items:r.middleware.slice(),next:function(){t.location.query=L(),f.items.length>0?(P("jqMVC -> router -> route -> mw -> next"),f.items.shift().call(this,f)):(P("jqMVC -> router -> route -> callback"),r.callback.apply(this,u))}};f.next(),e(c).off("accept",o),e(c).one("accept",o)}catch(l){var h=l.toString();switch(h){case"pass":O(i);break;case"halt":break;default:throw l}t.onerror=s,P("jqMVC -> router -> "+h)}}return!1}function M(e){var t=e?e:location.pathname;t=decodeURI(t);if(!i){if(location.hash.indexOf("#!/")!==0)return"";t+=location.hash.substring(3)}return t.slice(-1)=="/"&&(t=t.substring(0,t.length-1)),t}function _(e){var t=[];for(var n=0;n<o.length;n++){var r=o[n];if(r.type=="regexp"){var i=e.match(r.route);if(i){var s=function(){return r}();s.data={matches:i},t.push(s)}}else{var u=e.split("/"),a=r.route.split("/");if(a.length==u.length){var f={},l=!0,h=0;for(var p=0;p<a.length;p++)a[p].indexOf(":")===0?(f[a[p].substring(1)]=decodeURI(u[p]),h++):a[p]==u[p]&&h++;if(a.length==h){var s=function(){return r}();s.data=f,t.push(s),c.currentParameters=f}}}}return t}function D(e){e!=null&&e.originalEvent&&e.originalEvent.state!==undefined?A():s?A():!s&&!i&&A()}function P(){debug&&t.console&&console.log.apply(console,arguments)}function H(t,n){P("jqMVC -> emit -> "+t),e(r).trigger(t,n)}function B(){P("jqMVC -> unbindEvents");for(var t=0;t<y.length;t++)e(y[t]).find("*").addBack().off();y.length=0,clearInterval(c.interval)}function j(){P("jqMVC -> bindEvents");for(var e in b){var t=b[e];typeof t=="function"&&t.apply(this)}}function F(){P("jqMVC -> bindOneTimeEvents");for(var e=0;e<w.length;e++){var t=w[e];typeof t=="function"&&t.apply(this)}w.length=0}var r={},i=history&&history.pushState,s=!i&&"onhashchange"in t&&!1,o=[],u=!1,a=location.href,f=!0,l=!1,c={},h={alert:function(e){alert(e)},confirm:function(e,t){confirm(e)&&t.apply(this)}},p={start:function(){},stop:function(){}},d={render:function(){throw r.done(),"You must implement a view library to use this feature."}},v={},m={},g=e.fn.init,y=[],b={},w=[];t.location.origin=t.location.protocol+"//"+t.location.hostname+(t.location.port?":"+t.location.port:""),t.ctrl={},t.svc={},t.models={},t.app_path="/",t.api_path="/api/",t.view_path="/views",t.module_path="/modules",t.model_path="/models",t.element=e("body"),t.debug=!1,t.binding_override=!1,e.fn.serializeObject=function(){var e=this.serializeArray(),t={};for(var n=0;n<e.length;n++)t[e[n].name]=e[n].value;return t},e.fn.init=function(n,i){var s=E(n)&&!N(n)&&(S(n)||x(n)||T(n))!==!1,o=new g(n,i||t.document,e);return s&&(y=r.merge(y,[n])),o},b.bindRouter=function(){u=!0,c.fromHash=!1;if(i){if(location.hash.indexOf("#!/")===0){var n=location.pathname+location.hash.replace(/^#!\//gi,"");history.replaceState({},"",n),c.fromHash=!0}e(t).bind("popstate",D)}else s?e(t).bind("hashchange.router",D):c.interval=setInterval(function(){location.href!=a&&(D(),a=location.href)},500)},b.bindHref=function(){e(n).on("click","a[data-href]",function(t){return t.preventDefault(),H("before.go"),r.go(C().replace(/\/+$/,"")+e(this).data("href"),"Loading"),!1})},b.bindForm=function(){e(n).on("submit","form[method][ctrl][action][callback]",function(n){function i(){r.el.find('button[type="submit"]').prop("disabled",!0),e.ajax({url:api_path+r.action,type:r.method.toUpperCase(),data:r.data,contentType:r.type,cache:!1,processData:r.processData,success:function(e){var e=JSON.parse(e);t.ctrl[r.ctrl][r.cb].call(r.el,e)},error:function(e,n,i){t.ctrl[r.ctrl][r.cb].call(r.el,{error:1,message:e.status+" "+e.responseText})}}).always(function(){r.el.find('button[type="submit"]').prop("disabled",!1)})}n.preventDefault();var r={};return r.el=e(this),r.method=r.el.attr("method"),r.action=r.el.attr("action"),r.ctrl=r.el.attr("ctrl"),r.bf=r.el.attr("before"),r.cb=r.el.attr("callback"),r.isFile=!!r.el.find(':input[type="file"]').length,r.isFile?(r.data=new FormData(this),r.type=!1,r.processData=!1):(r.data=r.el.serializeObject(),r.type="application/x-www-form-urlencoded; charset=UTF-8",r.processData=!0),typeof r.bf=="function"?(new Promise(t.ctrl[r.ctrl][r.bf])).then(function(){i()},function(){}):i(),P(t,r),!1})},b.bindModel=function(){},m.items=[],m.next=function(){P("jqMVC -> middleware -> next()"),m.items.shift().call(e,m)},c.interval=null,c.currentId="",c.currentParameters={},c.capabilities={hash:s,pushState:i,timer:!s&&!i},c.checkRoute=function(e){return _(M(e)).length>0},c.parameters=function(e){var t=M(e),n=_(t);return n.length==0?c.currentParameters={}:c.currentParameters=n[0].data,c.currentParameters},r.add=function(e){return m.items.push(e),r},r.alert=function(){return h.alert.apply(this,arguments),r},r.before=function(){return p.start(),r},r.bind=function(e,t){if(binding_override||!b.hasOwnProperty(e))b[e]=t;return r},r.bindOnce=function(e){return w.push(e),r},r.checkCompatibility=function(){try{var t=e.fn.jquery.split("."),n=[];for(var i=0;i<t.length;i++)n.push(parseInt(t[i]));switch(!0){case n[0]<2:case n[1]<1:case n[2]<3:throw"jqMVC requires jQuery 2.1.3 or greater. Upgrade dummy!"}P("using jQuery version "+n.join("."))}catch(s){H("incompatible",{reason:s})}return r},r.confirm=function(){return h.confirm.apply(this,arguments),r},r.ctrl=function(e,t){return ctrl[e]=t,r},r.data=function(e){for(var n in e)t[n]=e[n];return r},r.done=function(t){return H("on.done"),p.stop(),B(),j(),F(),typeof t=="function"&&t.apply(this),e(c).trigger("accept"),!1},r.go=function(e){if(i)history.pushState({},null,e),A(),u||b.bindRouter();else{u||b.bindRouter(),e=e.replace(location.protocol+"//","").replace(location.hostname,"");var t=e.replace(location.pathname,"");t.indexOf("!")<0&&(t="!/"+t),location.hash=t}return r},r.halt=function(e){throw P("jqMVC -> router -> route -> mw -> reject"),typeof e=="function"&&e.apply(this),"halt"},r.loadModules=function(t){return t.length>0&&r.add(function(r){function i(t){var r=n.createElement("script");r.src=t,r.addEventListener("load",function(){s++,e(o).trigger("check")},!1),r.addEventListener("error",function(){s++,e(o).trigger("check")},!1),n.body.appendChild(r)}var s=0,o={};for(var u=0;u<t.length;u++)i(C()+module_path+t[u]);e(o).on("check",function(){s>=t.length&&r.next()})}),r},r.listen=function(t,n){return e(r).bind(t,n),r},r.listenOnce=function(t,n){return e(r).off(t,n),e(r).one(t,n),r},r.merge=function(){var e=[],t=[],n=function(e,t){var e=e.concat(t);for(var n=0;n<e.length;++n)for(var r=n+1;r<e.length;++r)e[n]===e[r]&&e.splice(r--,1);return e};Array.prototype.push.apply(e,arguments);for(k=0;k<e.length;k++)t=n(t,e[k]);return t},r.model=function(e,t){return v[e]=t,r},r.pass=function(){throw"pass"},r.render=function(){return d.render.apply(this,arguments),r},r.run=function(){r.add(function(){r.go(location.href)}),m.next(),r.run=function(){}},r.route=function(){var e=[];Array.prototype.push.apply(e,arguments);var t=e.shift(),n=e.pop(),i=e,s=typeof t=="object";return s||(t=C().replace(/\/+$/,"")+t,t.lastIndexOf("/")==t.length-1&&(t=t.substring(0,t.length-1)),t=t.replace(location.protocol+"//","").replace(location.hostname,"")),o.push({route:t,middleware:i,callback:n,type:s?"regexp":"string"}),r},r.setModel=function(e){return v=e,r},r.setNotification=function(e){return h=e,r},r.setProgress=function(e){return p=e,r},r.setView=function(e){return d=e,r},r.svc=function(e,t){return svc[e]=t,r},r.trigger=function(e,t){return H(e,t),r},r.debug=function(){return{routeList:o}},e.jqMVC=r}(jQuery,window,document)